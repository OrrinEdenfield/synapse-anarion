{
	"name": "WWI_script_02",
	"properties": {
		"content": {
			"query": "-- Only run this after the load of the internal/warehouse tables (WWI_script_01)\n\n-- View the data\nSELECT\n    r.command,\n    s.request_id,\n    r.status,\n    count(distinct input_name) as nbr_files,\n    sum(s.bytes_processed)/1024/1024/1024 as gb_processed\nFROM\n    sys.dm_pdw_exec_requests r\n    INNER JOIN sys.dm_pdw_dms_external_work s\n    ON r.request_id = s.request_id\nWHERE\n    r.[label] = 'CTAS : Load [wwi].[dimension_City]' OR\n    r.[label] = 'CTAS : Load [wwi].[dimension_Customer]' OR\n    r.[label] = 'CTAS : Load [wwi].[dimension_Employee]' OR\n    r.[label] = 'CTAS : Load [wwi].[dimension_PaymentMethod]' OR\n    r.[label] = 'CTAS : Load [wwi].[dimension_StockItem]' OR\n    r.[label] = 'CTAS : Load [wwi].[dimension_Supplier]' OR\n    r.[label] = 'CTAS : Load [wwi].[dimension_TransactionType]' OR\n    r.[label] = 'CTAS : Load [wwi].[fact_Movement]' OR\n    r.[label] = 'CTAS : Load [wwi].[fact_Order]' OR\n    r.[label] = 'CTAS : Load [wwi].[fact_Purchase]' OR\n    r.[label] = 'CTAS : Load [wwi].[fact_StockHolding]' OR\n    r.[label] = 'CTAS : Load [wwi].[fact_Transaction]'\nGROUP BY\n    r.command,\n    s.request_id,\n    r.status\nORDER BY\n    nbr_files desc,\n    gb_processed desc;\n\n \n-- View running queries on the sytem\nSELECT * FROM sys.dm_pdw_exec_requests;\n\n\n-- Create tables and procedures to generate the Date and Sales tables\nCREATE TABLE [wwi].[dimension_Date]\n(\n    [Date] [datetime] NOT NULL,\n    [Day Number] [int] NOT NULL,\n    [Day] [nvarchar](10) NOT NULL,\n    [Month] [nvarchar](10) NOT NULL,\n    [Short Month] [nvarchar](3) NOT NULL,\n    [Calendar Month Number] [int] NOT NULL,\n    [Calendar Month Label] [nvarchar](20) NOT NULL,\n    [Calendar Year] [int] NOT NULL,\n    [Calendar Year Label] [nvarchar](10) NOT NULL,\n    [Fiscal Month Number] [int] NOT NULL,\n    [Fiscal Month Label] [nvarchar](20) NOT NULL,\n    [Fiscal Year] [int] NOT NULL,\n    [Fiscal Year Label] [nvarchar](10) NOT NULL,\n    [ISO Week Number] [int] NOT NULL\n)\nWITH\n(\n    DISTRIBUTION = REPLICATE,\n    CLUSTERED INDEX ([Date])\n);\nCREATE TABLE [wwi].[fact_Sale]\n(\n    [Sale Key] [bigint] IDENTITY(1,1) NOT NULL,\n    [City Key] [int] NOT NULL,\n    [Customer Key] [int] NOT NULL,\n    [Bill To Customer Key] [int] NOT NULL,\n    [Stock Item Key] [int] NOT NULL,\n    [Invoice Date Key] [date] NOT NULL,\n    [Delivery Date Key] [date] NULL,\n    [Salesperson Key] [int] NOT NULL,\n    [WWI Invoice ID] [int] NOT NULL,\n    [Description] [nvarchar](100) NOT NULL,\n    [Package] [nvarchar](50) NOT NULL,\n    [Quantity] [int] NOT NULL,\n    [Unit Price] [decimal](18, 2) NOT NULL,\n    [Tax Rate] [decimal](18, 3) NOT NULL,\n    [Total Excluding Tax] [decimal](18, 2) NOT NULL,\n    [Tax Amount] [decimal](18, 2) NOT NULL,\n    [Profit] [decimal](18, 2) NOT NULL,\n    [Total Including Tax] [decimal](18, 2) NOT NULL,\n    [Total Dry Items] [int] NOT NULL,\n    [Total Chiller Items] [int] NOT NULL,\n    [Lineage Key] [int] NOT NULL\n)\nWITH\n(\n    DISTRIBUTION = HASH ( [WWI Invoice ID] ),\n    CLUSTERED COLUMNSTORE INDEX\n)\n\n\n\n-- Create [wwi].[InitialSalesDataPopulation] to increase the number of rows in [wwi].[seed_Sale] by a factor of eight.\nCREATE PROCEDURE [wwi].[InitialSalesDataPopulation] AS\nBEGIN\n    INSERT INTO [wwi].[seed_Sale] (\n        [Sale Key], [City Key], [Customer Key], [Bill To Customer Key], [Stock Item Key], [Invoice Date Key], [Delivery Date Key], [Salesperson Key], [WWI Invoice ID], [Description], [Package], [Quantity], [Unit Price], [Tax Rate], [Total Excluding Tax], [Tax Amount], [Profit], [Total Including Tax], [Total Dry Items], [Total Chiller Items], [Lineage Key]\n    )\n    SELECT\n        [Sale Key], [City Key], [Customer Key], [Bill To Customer Key], [Stock Item Key], [Invoice Date Key], [Delivery Date Key], [Salesperson Key], [WWI Invoice ID], [Description], [Package], [Quantity], [Unit Price], [Tax Rate], [Total Excluding Tax], [Tax Amount], [Profit], [Total Including Tax], [Total Dry Items], [Total Chiller Items], [Lineage Key]\n    FROM [wwi].[seed_Sale]\n\n    INSERT INTO [wwi].[seed_Sale] (\n        [Sale Key], [City Key], [Customer Key], [Bill To Customer Key], [Stock Item Key], [Invoice Date Key], [Delivery Date Key], [Salesperson Key], [WWI Invoice ID], [Description], [Package], [Quantity], [Unit Price], [Tax Rate], [Total Excluding Tax], [Tax Amount], [Profit], [Total Including Tax], [Total Dry Items], [Total Chiller Items], [Lineage Key]\n    )\n    SELECT\n        [Sale Key], [City Key], [Customer Key], [Bill To Customer Key], [Stock Item Key], [Invoice Date Key], [Delivery Date Key], [Salesperson Key], [WWI Invoice ID], [Description], [Package], [Quantity], [Unit Price], [Tax Rate], [Total Excluding Tax], [Tax Amount], [Profit], [Total Including Tax], [Total Dry Items], [Total Chiller Items], [Lineage Key]\n    FROM [wwi].[seed_Sale]\n\n    INSERT INTO [wwi].[seed_Sale] (\n        [Sale Key], [City Key], [Customer Key], [Bill To Customer Key], [Stock Item Key], [Invoice Date Key], [Delivery Date Key], [Salesperson Key], [WWI Invoice ID], [Description], [Package], [Quantity], [Unit Price], [Tax Rate], [Total Excluding Tax], [Tax Amount], [Profit], [Total Including Tax], [Total Dry Items], [Total Chiller Items], [Lineage Key]\n    )\n    SELECT\n        [Sale Key], [City Key], [Customer Key], [Bill To Customer Key], [Stock Item Key], [Invoice Date Key], [Delivery Date Key], [Salesperson Key], [WWI Invoice ID], [Description], [Package], [Quantity], [Unit Price], [Tax Rate], [Total Excluding Tax], [Tax Amount], [Profit], [Total Including Tax], [Total Dry Items], [Total Chiller Items], [Lineage Key]\n    FROM [wwi].[seed_Sale]\nEND\n\n\n-- Create this stored procedure that populates rows into wwi.dimension_Date.\nCREATE PROCEDURE [wwi].[PopulateDateDimensionForYear] @Year [int] AS\nBEGIN\n    IF OBJECT_ID('tempdb..#month', 'U') IS NOT NULL\n        DROP TABLE #month\n    CREATE TABLE #month (\n        monthnum int,\n        numofdays int\n    )\n    WITH ( DISTRIBUTION = ROUND_ROBIN, heap )\n    INSERT INTO #month\n        SELECT 1, 31 UNION SELECT 2, CASE WHEN (@YEAR % 4 = 0 AND @YEAR % 100 <> 0) OR @YEAR % 400 = 0 THEN 29 ELSE 28 END UNION SELECT 3,31 UNION SELECT 4,30 UNION SELECT 5,31 UNION SELECT 6,30 UNION SELECT 7,31 UNION SELECT 8,31 UNION SELECT 9,30 UNION SELECT 10,31 UNION SELECT 11,30 UNION SELECT 12,31\n\n    IF OBJECT_ID('tempdb..#days', 'U') IS NOT NULL\n        DROP TABLE #days\n    CREATE TABLE #days (days int)\n    WITH (DISTRIBUTION = ROUND_ROBIN, HEAP)\n\n    INSERT INTO #days\n        SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10 UNION SELECT 11 UNION SELECT 12 UNION SELECT 13 UNION SELECT 14 UNION SELECT 15 UNION SELECT 16 UNION SELECT 17 UNION SELECT 18 UNION SELECT 19 UNION SELECT 20    UNION SELECT 21 UNION SELECT 22 UNION SELECT 23 UNION SELECT 24 UNION SELECT 25 UNION SELECT 26 UNION SELECT 27 UNION SELECT 28 UNION SELECT 29 UNION SELECT 30 UNION SELECT 31\n\n    INSERT [wwi].[dimension_Date] (\n        [Date], [Day Number], [Day], [Month], [Short Month], [Calendar Month Number], [Calendar Month Label], [Calendar Year], [Calendar Year Label], [Fiscal Month Number], [Fiscal Month Label], [Fiscal Year], [Fiscal Year Label], [ISO Week Number]\n    )\n    SELECT\n        CAST(CAST(monthnum AS VARCHAR(2)) + '/' + CAST([days] AS VARCHAR(3)) + '/' + CAST(@year AS CHAR(4)) AS DATE) AS [Date]\n        ,DAY(CAST(CAST(monthnum AS VARCHAR(2)) + '/' + CAST([days] AS VARCHAR(3)) + '/' + CAST(@year AS CHAR(4)) AS DATE)) AS [Day Number]\n        ,CAST(DATENAME(day, CAST(CAST(monthnum AS VARCHAR(2)) + '/' + CAST([days] AS VARCHAR(3)) + '/' + CAST(@year AS CHAR(4)) AS DATE)) AS NVARCHAR(10)) AS [Day]\n        ,CAST(DATENAME(month, CAST(CAST(monthnum AS VARCHAR(2)) + '/' + CAST([days] AS VARCHAR(3)) + '/' + CAST(@year as char(4)) AS DATE)) AS nvarchar(10)) AS [Month]\n        ,CAST(SUBSTRING(DATENAME(month, CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)), 1, 3) AS nvarchar(3)) AS [Short Month]\n        ,MONTH(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) AS [Calendar Month Number]\n        ,CAST(N'CY' + CAST(YEAR(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) AS nvarchar(4)) + N'-' + SUBSTRING(DATENAME(month, CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)), 1, 3) AS nvarchar(10)) AS [Calendar Month Label]\n        ,YEAR(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) AS [Calendar Year]\n        ,CAST(N'CY' + CAST(YEAR(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) AS nvarchar(4)) AS nvarchar(10)) AS [Calendar Year Label]\n        ,CASE WHEN MONTH(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) IN (11, 12)\n        THEN MONTH(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) - 10\n        ELSE MONTH(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) + 2 END AS [Fiscal Month Number]\n        ,CAST(N'FY' + CAST(CASE WHEN MONTH(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) IN (11, 12)\n        THEN YEAR(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) + 1\n        ELSE YEAR(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) END AS nvarchar(4)) + N'-' + SUBSTRING(DATENAME(month, CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)), 1, 3) AS nvarchar(20)) AS [Fiscal Month Label]\n        ,CASE WHEN MONTH(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) IN (11, 12)\n        THEN YEAR(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) + 1\n        ELSE YEAR(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) END AS [Fiscal Year]\n        ,CAST(N'FY' + CAST(CASE WHEN MONTH(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) IN (11, 12)\n        THEN YEAR(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) + 1\n        ELSE YEAR(CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE))END AS nvarchar(4)) AS nvarchar(10)) AS [Fiscal Year Label]\n        , DATEPART(ISO_WEEK, CAST(CAST(monthnum as varchar(2)) + '/' + CAST([days] as varchar(3)) + '/' + CAST(@year as char(4)) AS DATE)) AS [ISO Week Number]\nFROM #month m\n    CROSS JOIN #days d\nWHERE d.days <= m.numofdays\n\nDROP table #month;\nDROP table #days;\nEND;\n\n-- Create this procedure that populates the wwi.dimension_Date and wwi.fact_Sale tables. It calls [wwi].[PopulateDateDimensionForYear] to populate wwi.dimension_Date.\nCREATE PROCEDURE [wwi].[Configuration_PopulateLargeSaleTable] @EstimatedRowsPerDay [bigint],@Year [int] AS\nBEGIN\n    SET NOCOUNT ON;\n    SET XACT_ABORT ON;\n\n    EXEC [wwi].[PopulateDateDimensionForYear] @Year;\n\n    DECLARE @OrderCounter bigint = 0;\n    DECLARE @NumberOfSalesPerDay bigint = @EstimatedRowsPerDay;\n    DECLARE @DateCounter date;\n    DECLARE @StartingSaleKey bigint;\n    DECLARE @MaximumSaleKey bigint = (SELECT MAX([Sale Key]) FROM wwi.seed_Sale);\n    DECLARE @MaxDate date;\n    SET @MaxDate = (SELECT MAX([Invoice Date Key]) FROM wwi.fact_Sale)\n    IF ( @MaxDate < CAST(@YEAR AS CHAR(4)) + '1231') AND (@MaxDate > CAST(@YEAR AS CHAR(4)) + '0101')\n        SET @DateCounter = @MaxDate\n    ELSE\n        SET @DateCounter= CAST(@Year as char(4)) + '0101';\n\n    PRINT 'Targeting ' + CAST(@NumberOfSalesPerDay AS varchar(20)) + ' sales per day.';\n\n    DECLARE @OutputCounter varchar(20);\n    DECLARE @variance DECIMAL(18,10);\n    DECLARE @VariantNumberOfSalesPerDay BIGINT;\n\n    WHILE @DateCounter < CAST(@YEAR AS CHAR(4)) + '1231'\n    BEGIN\n        SET @OutputCounter = CONVERT(varchar(20), @DateCounter, 112);\n        RAISERROR(@OutputCounter, 0, 1);\n        SET @variance = (SELECT RAND() * 10)*.01 + .95\n        SET @VariantNumberOfSalesPerDay = FLOOR(@NumberOfSalesPerDay * @variance)\n\n        SET @StartingSaleKey = @MaximumSaleKey - @VariantNumberOfSalesPerDay - FLOOR(RAND() * 20000);\n        SET @OrderCounter = 0;\n\n        INSERT [wwi].[fact_Sale] (\n            [City Key], [Customer Key], [Bill To Customer Key], [Stock Item Key], [Invoice Date Key], [Delivery Date Key], [Salesperson Key], [WWI Invoice ID], [Description], Package, Quantity, [Unit Price], [Tax Rate], [Total Excluding Tax], [Tax Amount], Profit, [Total Including Tax], [Total Dry Items], [Total Chiller Items], [Lineage Key]\n        )\n        SELECT TOP(@VariantNumberOfSalesPerDay)\n            [City Key], [Customer Key], [Bill To Customer Key], [Stock Item Key], @DateCounter, DATEADD(day, 1, @DateCounter), [Salesperson Key], [WWI Invoice ID], [Description], Package, Quantity, [Unit Price], [Tax Rate], [Total Excluding Tax], [Tax Amount], Profit, [Total Including Tax], [Total Dry Items], [Total Chiller Items], [Lineage Key]\n        FROM [wwi].[seed_Sale]\n        WHERE\n             --[Sale Key] > @StartingSaleKey and /* IDENTITY DOES NOT WORK THE SAME IN SQLDW AND CAN'T USE THIS METHOD FOR VARIANT */\n            [Invoice Date Key] >=cast(@YEAR AS CHAR(4)) + '-01-01'\n        ORDER BY [Sale Key];\n\n        SET @DateCounter = DATEADD(day, 1, @DateCounter);\n    END;\n\nEND;\n\n\n-- Generate millions of rows\n-- Run this procedure to seed the [wwi].[seed_Sale] with more rows.\nEXEC [wwi].[InitialSalesDataPopulation]\n\n--Run this procedure to populate wwi.fact_Sale with 100,000 rows per day for each day in the year 2000.\nEXEC [wwi].[Configuration_PopulateLargeSaleTable] 100000, 2000\n\n--The data generation in the previous step might take a while as it progresses through the year. To see which day the current process is on, open a new query and run this SQL command:\nSELECT MAX([Invoice Date Key]) FROM wwi.fact_Sale;\n\n\n-- Run the following command to see the space used.\nEXEC sp_spaceused N'wwi.fact_Sale';\n\n\n-- Populate the replicated table cache\nSELECT TOP 1 * FROM [wwi].[dimension_City];\nSELECT TOP 1 * FROM [wwi].[dimension_Customer];\nSELECT TOP 1 * FROM [wwi].[dimension_Date];\nSELECT TOP 1 * FROM [wwi].[dimension_Employee];\nSELECT TOP 1 * FROM [wwi].[dimension_PaymentMethod];\nSELECT TOP 1 * FROM [wwi].[dimension_StockItem];\nSELECT TOP 1 * FROM [wwi].[dimension_Supplier];\nSELECT TOP 1 * FROM [wwi].[dimension_TransactionType];\n\n\n-- Create statistics on newly loaded data\nCREATE PROCEDURE    [dbo].[prc_sqldw_create_stats]\n(   @create_type    tinyint -- 1 default 2 Fullscan 3 Sample\n,   @sample_pct     tinyint\n)\nAS\n\nIF @create_type IS NULL\nBEGIN\n    SET @create_type = 1;\nEND;\n\nIF @create_type NOT IN (1,2,3)\nBEGIN\n    THROW 151000,'Invalid value for @stats_type parameter. Valid range 1 (default), 2 (fullscan) or 3 (sample).',1;\nEND;\n\nIF @sample_pct IS NULL\nBEGIN;\n    SET @sample_pct = 20;\nEND;\n\nIF OBJECT_ID('tempdb..#stats_ddl') IS NOT NULL\nBEGIN;\n    DROP TABLE #stats_ddl;\nEND;\n\nCREATE TABLE #stats_ddl\nWITH    (   DISTRIBUTION    = HASH([seq_nmbr])\n        ,   LOCATION        = USER_DB\n        )\nAS\nWITH T\nAS\n(\nSELECT      t.[name]                        AS [table_name]\n,           s.[name]                        AS [table_schema_name]\n,           c.[name]                        AS [column_name]\n,           c.[column_id]                   AS [column_id]\n,           t.[object_id]                   AS [object_id]\n,           ROW_NUMBER()\n            OVER(ORDER BY (SELECT NULL))    AS [seq_nmbr]\nFROM        sys.[tables] t\nJOIN        sys.[schemas] s         ON  t.[schema_id]       = s.[schema_id]\nJOIN        sys.[columns] c         ON  t.[object_id]       = c.[object_id]\nLEFT JOIN   sys.[stats_columns] l   ON  l.[object_id]       = c.[object_id]\n                                    AND l.[column_id]       = c.[column_id]\n                                    AND l.[stats_column_id] = 1\nLEFT JOIN    sys.[external_tables] e    ON    e.[object_id]        = t.[object_id]\nWHERE       l.[object_id] IS NULL\nAND            e.[object_id] IS NULL -- not an external table\n)\nSELECT  [table_schema_name]\n,       [table_name]\n,       [column_name]\n,       [column_id]\n,       [object_id]\n,       [seq_nmbr]\n,       CASE @create_type\n        WHEN 1\n        THEN    CAST('CREATE STATISTICS '+QUOTENAME('stat_'+table_schema_name+ '_' + table_name + '_'+column_name)+' ON '+QUOTENAME(table_schema_name)+'.'+QUOTENAME(table_name)+'('+QUOTENAME(column_name)+')' AS VARCHAR(8000))\n        WHEN 2\n        THEN    CAST('CREATE STATISTICS '+QUOTENAME('stat_'+table_schema_name+ '_' + table_name + '_'+column_name)+' ON '+QUOTENAME(table_schema_name)+'.'+QUOTENAME(table_name)+'('+QUOTENAME(column_name)+') WITH FULLSCAN' AS VARCHAR(8000))\n        WHEN 3\n        THEN    CAST('CREATE STATISTICS '+QUOTENAME('stat_'+table_schema_name+ '_' + table_name + '_'+column_name)+' ON '+QUOTENAME(table_schema_name)+'.'+QUOTENAME(table_name)+'('+QUOTENAME(column_name)+') WITH SAMPLE '+CONVERT(varchar(4),@sample_pct)+' PERCENT' AS VARCHAR(8000))\n        END AS create_stat_ddl\nFROM T\n;\n\nDECLARE @i INT              = 1\n,       @t INT              = (SELECT COUNT(*) FROM #stats_ddl)\n,       @s NVARCHAR(4000)   = N''\n;\n\nWHILE @i <= @t\nBEGIN\n    SET @s=(SELECT create_stat_ddl FROM #stats_ddl WHERE seq_nmbr = @i);\n    PRINT @s\n    EXEC sp_executesql @s\n    SET @i+=1;\nEND\n\nDROP TABLE #stats_ddl;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "SynapseSQLDedicated",
				"poolName": "SynapseSQLDedicated"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}