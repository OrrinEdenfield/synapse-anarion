{
	"name": "Demo-KQL-IoT-Building-Sensor",
	"properties": {
		"content": {
			"query": "// Drop target table for IoT data:\n//.drop table buidingenv\n\n// Create target table for IoT data:\n.create table buidingenv (timestamp: datetime, temperature: real, humidity: real)\n.create table buidingenv ingestion json mapping 'buidingenvMapping' '[{\"column\": \"timestamp\",\"path\": \"$.timestamp\",\"datatype\": \"datetime\" },{\"column\": \"humidity\",\"path\": \"$.humidity\",\"datatype\": \"real\"},{\"column\": \"temperature\",\"path\": \"$.temperature\",\"datatype\": \"real\"}]'\n\n// Return all records\nbuidingenv_v2 | count\n\n\n// Return all records for the last day\nbuidingenv_v2\n//| where timestamp > now(-1d) and timestamp <= now()\n| order by timestamp desc\n| limit 10\n| count\n\n\n// Average temperature by date & hour, rounded to 2 decimal places\nbuidingenv \n| summarize round(avg(temperature),2) by \n     year = datetime_part(\"year\", timestamp)\n    ,month = datetime_part(\"month\", timestamp)\n    ,day = datetime_part(\"day\", timestamp)\n    ,hour = datetime_part(\"hour\", timestamp)\n| where hour != ''\n| order by year asc, month asc, day asc, hour asc\n\n// Count of records per hour\nbuidingenv \n| summarize RecordCount = count() by ISO8601 = substring(tostring(timestamp),0,13)\n| where ISO8601 != ''\n| order by ISO8601 asc\n\n\n// Now switch to the new table\n\n// Count of messages per deviceID\nbuidingenv_v2\n| summarize RecordCount = count() by device = deviceid\n| order by device asc\n// IoTUbuntu           3405\n// IoTWinServer2019    2493\n\n// Count of records per hour\nbuidingenv_v2\n| summarize RecordCount = count() by ISO8601 = substring(tostring(timestamp),0,13), deviceid\n| where ISO8601 != '' and ISO8601 != '2021-09-24T13'\n| order by ISO8601 desc, deviceid asc\n\n\n\n// Daily query to extract from ADX cluster & persist for historical analysis\nbuidingenv_v2\n| where toint(datetime_part(\"day\", timestamp)) == datetime_part(\"day\", now(-1d))\n| count\n// 77,820\n\n// Compare yesterday's data to the day before\nbuidingenv_v2\n| where toint(datetime_part(\"day\", timestamp)) == datetime_part(\"day\", now(-2d))\n| count\n// 138,451\n\n// Compare yesterday's data to the day before, and the day before that\nbuidingenv_v2\n| where toint(datetime_part(\"day\", timestamp)) == datetime_part(\"day\", now(-3d))\n| count\n// 162,208\n\n// Count of records per hour, exclude first hour data was sent in & latest 1 hour increment\nbuidingenv_v2\n| summarize RecordCount = count() by ISO8601 = substring(tostring(timestamp),0,13), deviceid\n| where ISO8601 != '' and ISO8601 != '2021-09-24T13' and ISO8601 != substring(tostring(now()),0,13)\n| order by ISO8601 desc, deviceid asc\n\n// Return most recent records added\nbuidingenv_v2\n| order by timestamp desc\n| limit 15",
			"metadata": {
				"language": "kql"
			}
		},
		"type": "KqlQuery"
	}
}